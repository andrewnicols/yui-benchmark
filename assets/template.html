<!DOCTYPE html>
<html>
	<head>
		<script src="/benchmark.js"></script>
		<script>
		
		YUI_BENCH_TASKID = "{{taskID}}";

		var seedCount = {{seedCount}},
			instanceCount = 0,
			suite = new Benchmark.Suite(),
			results = [],
			testsAdded = 0,
			testsCompleted = 0;

		suite._add = suite.add;
		suite.add = function (config) {
			testsAdded++;
			var benchmark = config.Y.Benchmark;
			// config.name = config.name + ' (' + config.Y.Benchmark.sha + ')';
			config.ref = benchmark.ref;
			config.sha = benchmark.sha;
			config.testID = benchmark.testID;
			config.taskID = benchmark.taskID;
			delete config.Y;
			suite._add(config);
		}

        suite.on('complete', function () {
			console.log('complete');
			// console.log('Fastest is ' + this.filter('fastest').pluck('name'));
            for(var i = 0; i < this.length; i++) {
                addResult({
                    name: this[i].name,
                    value: this[i].hz,
                    stats: this[i].stats,
                    ref: this[i].ref,
                    sha: this[i].sha,
                    testID: this[i].testID,
                    taskID: this[i].taskID,
                });
            }
            _sendResult();
        });
		suite.on('start', function(event) {
			console.log('start');
		});
		suite.on('cycle', function(event) {
			console.log('Cycle');
		});
		suite.on('error', function () {
			// console.log('error');
		});
		suite.on('abort', function () {
			// console.log('abort');
		});
		suite.on('reset', function () {
			// console.log('reset');
		});

		function registerInstance(YUI, data) {
				
			console.log(YUI.seedBase + ': registerInstance');

			var modulePath = data.modulePath,
				name = data.name,
				taskID = data.taskID,
				testID = data.testID,
				YUI_instance,
				config = {
					base: YUI.seedBase + "/build/",
					filter: 'raw',
					modules: {}
				};

			config.modules[name] = { fullpath : modulePath };
			
			YUI_instance = new YUI(config);

			YUI_instance.Benchmark = {
				suite: suite,
				sha: YUI.sha,
				ref: YUI.ref,
				taskID: taskID,
				testID: testID
			}

			YUI_instance.use(name, function (Y) {
				if (Y.Benchmark.sha == 'WIP') {
					// Todo: Find a better wayleak a Y
					window.Y = Y;
				    function YUIBench () { /* Nothing, for now */}
				    Y.augment(YUIBench, Y.EventTarget);
				    // Set a global for Yeti detection
				    Y.config.win.YUIBench = new YUIBench();
				}

				console.log(Y.Benchmark.sha + ': use');
				instanceCount++;

				if (instanceCount === seedCount) {
					document.getElementById('testCount').innerHTML = testsAdded;
					document.getElementById('seconds').innerHTML = testsAdded * 10;
					setTimeout(ready, 500);
				}
			});
		}

		function ready() {
			console.log('ready');
			console.log(suite);
			suite.run();
		}

	    function addResult (result) {
	        result.taskID = YUI_BENCH_TASKID;
	        console.log(result);
	        results.push(result);
	    }

	    function _sendResult () {
	        // TODO: Figure out a way to not have this be delayed
	        Y.later(1000, Y.config.win.YUIBench, function () {
	            this.fire('complete', {results: results});
	        });
	    };
		</script>
		{{head}}
	</head>

	<body class="yui3-skin-sam">
		<h1>YUI Benchmark</h1>
		<p><span id="testCount"></span> test(s) found, so I estimate this should take about <span id="seconds"></span> second(s).  Patience!</p>
	</body>
</html>