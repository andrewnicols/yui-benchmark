<!DOCTYPE html>
<html>
	<head>
		<script src="/benchmark.js"></script>
		<script>

        var seedCount = {{seedCount}}, // How many seeds are we loading on the page?
            instanceCount = 0, // How many seeds have been loaded on the page?
            suite = new Benchmark.Suite,
            YUIBenchmark = null;

        // Register a YUI object 
        function registerYUI(YUI, data) {

            console.log(data.ref + ': registerInstance');

            var testModulePath = data.modulePath,
                testModuleName = data.name,
                pathToSeedBuild = data.seedBase + '/build/',
                YUIConfig = {
                    filter: 'raw',
                    base: pathToSeedBuild,
                    modules: {} // Populated later
                },
                sha = data.sha,
                ref = data.ref,
                taskID = data.taskID,
                testID = data.testID;

            // Adds Y.Benchmark and Y.BenchmarkSuite
            YUI.add('benchmark', moduleBenchmark, null, {requires:['oop', 'event']});

            // Require the test module
            YUIConfig.modules[testModuleName] = {
                fullpath: testModulePath
            };

            YUI(YUIConfig).use(testModuleName, function (Y) {
                var test;

                while (test = Y.BenchmarkSuite.shift()) {
                    test.sha = sha;
                    test.ref = ref;
                    test.testID = testID;
                    test.taskID = taskID;
                    suite.push(test);
                }

                console.log(sha + ': use');
                instanceCount++;

                if (instanceCount === seedCount) {
                    document.getElementById('testCount').innerHTML = suite.length;
                    document.getElementById('seconds').innerHTML = suite.length * 10;

                    // Go to the next tick to allow the DOM updates on the last few lines
                    setTimeout(executeTests, 100);
                }
            });

            // Set a global for Yeti detection
            if (!window.YUIBenchmark) {
                window.YUIBenchmark = true; // Next line is async, so set this to something now
                YUI().use('benchmark', function (Y) {
                    window.YUIBenchmark = new Y.Benchmark();
                });
            }
        }

        // Assigns listeners to test suite and kicks off the run()
        function executeTests() {
            console.log('-----');
            console.log('ready');
            suite.on('complete', testsComplete);
            suite.on('start', function (event) {
                console.log('start');
            });
            suite.on('cycle', function (event) {
                console.log('cycle');
            });
            suite.run();
        }

        // onComplete listener to coallate the results and fire an event that Yeti picks up
        function testsComplete() {
            var benchmark = window.YUIBenchmark,
                test;

            while (test = this.shift()) {
                benchmark.addResult({
                    name: test.name,
                    value: test.hz,
                    ref: test.ref,
                    sha: test.sha,
                    testID: test.testID,
                    taskID: test.taskID,
                    stats: test.stats
                });
            }

            // Requires delay to wait for Yeti to detect this driver
            setTimeout(function () {
                benchmark.broadcastResults();
            }, 1000);
        }

        function moduleBenchmark(Y, NAME) {

            function YBenchmark() { 
                this.results = [];
            }

            YBenchmark.prototype.addResult = function (result) {
                this.results.push(result);
            }
            
            YBenchmark.prototype.broadcastResults = function () {
                console.log('fire results');
                console.log(this.results);
                this.fire('results', {results: this.results});
            }

            Y.augment(YBenchmark, Y.EventTarget);

            Y.Benchmark = YBenchmark;
        }
		</script>

        <!-- Head -->
		{{head}}
        <!-- Head -->
	</head>

	<body class="yui3-skin-sam">
		<h1>YUI Benchmark</h1>
		<p><span id="testCount"></span> test(s) found, so I estimate this should take about <span id="seconds"></span> second(s).  Patience!</p>

        <!-- Body -->
        {{body}}
        <!-- /Body -->
	</body>
</html>