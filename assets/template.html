<!DOCTYPE html>
<html>
	<head>
		<script src="/benchmark.js"></script>
		<script>

		var seedCount = {{seedCount}},
			instanceCount = 0,
			suite = new Benchmark.Suite(),
			results = [];

		function registerInstance(YUI, data) {
				
			console.log(YUI.seedBase + ': registerInstance');

			var testModulePath = data.modulePath,
				testModuleName = data.name,
				config = {
					base: YUI.seedBase + "/build/",
					filter: 'raw',
					modules: {}
				},
				YUIinstance;

			YUI.add('benchmark', function YBenchmark (Y, NAME) {
		    	Y.BenchmarkSuite = {
	    			add: function () {
	    				suite.add.apply(suite, arguments);
	    				var test = suite.shift();
	    				test.sha = Y.BenchmarkData.sha;
	    				test.ref = Y.BenchmarkData.ref;
	    				test.taskID = Y.BenchmarkData.taskID;
	    				test.testID = Y.BenchmarkData.testID;
	    			}
				}
		    });

			config.modules[testModuleName] = { 
				fullpath : testModulePath, 
				requires: ['benchmark']
			};

			YUIinstance = new YUI(config);
			YUIinstance.BenchmarkData = {
	    		sha: YUI.sha,
	    		ref: YUI.ref,
	    		taskID: data.taskID,
	    		testID: data.testID,
			};

			YUIinstance.use(testModuleName, function (Y) {
				if (!window.Y) {
					// Todo: Find a better wayleak a Y
					window.Y = Y;
				    function YUIBench () { /* Nothing, for now */}
				    Y.augment(YUIBench, Y.EventTarget);
				    // Set a global for Yeti detection
				    Y.config.win.YUIBench = new YUIBench();
				}
				console.log(Y.BenchmarkData.sha + ': use');
				instanceCount++;

				if (instanceCount === seedCount) {
					document.getElementById('testCount').innerHTML = suite.length;
					document.getElementById('seconds').innerHTML = suite.length * 10;
					setTimeout(ready, 1);
				}
			});
		}

		function ready() {
			console.log('ready');
	        suite.on('complete', function () {
				console.log('complete');
	            for(var i = 0; i < this.length; i++) {
	                addResult({
	                    name: this[i].name,
	                    value: this[i].hz,
	                    stats: this[i].stats,
	                    ref: this[i].ref,
	                    sha: this[i].sha,
	                    testID: this[i].testID,
	                    taskID: this[i].taskID,
	                });
	            }
	            _sendResults();
	        });
			suite.on('start', function(event) {
				console.log('start');
			});
			suite.on('cycle', function(event) {
				console.log('Cycle');
			});

			console.log(suite);
			suite.run();
		}

	    function addResult (result) {
	    	console.log("Added result");
	    	console.log(result);
	        results.push(result);
	    }

	    function _sendResults () {
	        // TODO: Figure out a way to not have this be delayed
	        Y.later(1000, Y.config.win.YUIBench, function () {
	            this.fire('complete', {results: results});
	        });
	    };
		</script>
		{{head}}
	</head>

	<body class="yui3-skin-sam">
		<h1>YUI Benchmark</h1>
		<p><span id="testCount"></span> test(s) found, so I estimate this should take about <span id="seconds"></span> second(s).  Patience!</p>
	</body>
</html>