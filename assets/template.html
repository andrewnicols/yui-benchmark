<!DOCTYPE html>
<html>
	<head>
		<script src="/benchmark.js"></script>
		<script>
        var seedCount = {{seedCount}},
            instanceCount = 0,
            testResults = [],
            suite = new Benchmark.Suite,
            YUIBenchmark = null;

        // Register a YUI object 
        function registerInstance(YUI, data) {

            console.log(YUI.seedBase + ': registerInstance');

            var testModulePath = data.modulePath,
                testModuleName = data.name,
                pathToSeedBuild = YUI.seedBase + '/build/',
                config = {
                    filter: 'raw',
                    base: pathToSeedBuild,
                    modules: {} // Populated later
                },
                YUIinstance; // aka: Y

            // Adds Y.Benchmark and Y.BenchmarkSuite
            YUI.add('benchmark', moduleBenchmark);

            // Require the test module
            config.modules[testModuleName] = {
                fullpath: testModulePath,
                requires: ['benchmark']
            };

            // Create an instance of YUI
            YUIinstance = new YUI(config);

            // Store some benchmarking data on the instance
            YUIinstance.BenchmarkData = {
                sha: YUI.sha,
                ref: YUI.ref,
                taskID: data.taskID,
                testID: data.testID
            };

            // use()
            YUIinstance.use(testModuleName, function (Y) {

                // Set a global for Yeti detection
                if (!Y.config.win.YUIBenchmark) {
                    Y.config.win.YUIBenchmark = new Y.Benchmark();
                }

                console.log(Y.BenchmarkData.sha + ': use');
                instanceCount++;

                if (instanceCount === seedCount) {
                    document.getElementById('testCount').innerHTML = suite.length;
                    document.getElementById('seconds').innerHTML = suite.length * 10;

                    // Go to the next tick to allow the DOM updates on the last few lines
                    setTimeout(executeTests, 1);
                }
            });
        }

        // Assigns listeners to test suite and kicks off the run()
        function executeTests() {
            console.log('-----');
            console.log('ready');
            suite.on('complete', testsComplete);
            suite.on('start', function (event) {
                console.log('start');
            });
            suite.on('cycle', function (event) {
                console.log('cycle');
            });
            suite.run();
        }

        // onComplete listener to coallate the results and fire an event that Yeti picks up
        function testsComplete() {
            var benchmark = YUIBenchmark,
                test;

            while (test = this.shift()) {
                benchmark.addResult({
                    name: test.name,
                    value: test.hz,
                    ref: test.ref,
                    sha: test.sha,
                    testID: test.testID,
                    taskID: test.taskID,
                    stats: test.stats
                });
            }

            // Requires delay to wait for Yeti to detect this driver
            setTimeout(function () {
                benchmark.broadcastResults();
            }, 1000);
        }

        function moduleBenchmark(Y, NAME) {

            function YBenchmark() { 
                this.results = [];
            }

            YBenchmark.prototype.addResult = function (result) {
                this.results.push(result);
            }
            
            YBenchmark.prototype.broadcastResults = function () {
                console.log('fire');
                this.fire('results', {results: this.results});
            }

            Y.augment(YBenchmark, Y.EventTarget);


            function YBenchmarkSuite() {
                YBenchmarkSuite.superclass.constructor.apply(this, arguments);
            }

            Y.extend(YBenchmarkSuite, Benchmark.Suite, {
                // Override Benchmark's `run` method so it doesn't execute the test suite, 
                // but instead removes all tests and pushes them on to a global suite
                run: function () {
                    var test;
                    while (test = this.shift()) {
                        test.sha = Y.BenchmarkData.sha;
                        test.ref = Y.BenchmarkData.ref;
                        test.testID = Y.BenchmarkData.testID;
                        test.taskID = Y.BenchmarkData.taskID;
                        suite.push(test);
                    }
                }
            });

            Y.Benchmark = YBenchmark;
            Y.BenchmarkSuite = YBenchmarkSuite;
        }
		</script>
		{{head}}
	</head>

	<body class="yui3-skin-sam">
		<h1>YUI Benchmark</h1>
		<p><span id="testCount"></span> test(s) found, so I estimate this should take about <span id="seconds"></span> second(s).  Patience!</p>
	</body>
</html>